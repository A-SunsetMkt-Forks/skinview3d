{"version":3,"file":"skinview3d.min.js","sources":["../src/model.ts","../src/animation.ts","../node_modules/skinview-utils/index.js","../src/orbit_controls.ts","../src/viewer.ts"],"sourcesContent":["import { BoxGeometry, DoubleSide, FrontSide, Group, Mesh, MeshBasicMaterial, Object3D, Texture, Vector2 } from \"three\";\n\nfunction toFaceVertices(x1: number, y1: number, x2: number, y2: number, w: number, h: number) {\n\treturn [\n\t\tnew Vector2(x1 / w, 1.0 - y2 / h),\n\t\tnew Vector2(x2 / w, 1.0 - y2 / h),\n\t\tnew Vector2(x2 / w, 1.0 - y1 / h),\n\t\tnew Vector2(x1 / w, 1.0 - y1 / h)\n\t];\n}\n\nfunction toSkinVertices(x1: number, y1: number, x2: number, y2: number) {\n\treturn toFaceVertices(x1, y1, x2, y2, 64.0, 64.0);\n}\n\nfunction toCapeVertices(x1: number, y1: number, x2: number, y2: number) {\n\treturn toFaceVertices(x1, y1, x2, y2, 64.0, 32.0);\n}\n\nfunction setVertices(box: BoxGeometry, top: Array<Vector2>, bottom: Array<Vector2>, left: Array<Vector2>, front: Array<Vector2>, right: Array<Vector2>, back: Array<Vector2>) {\n\n\tbox.faceVertexUvs[0] = [];\n\tbox.faceVertexUvs[0][0] = [right[3], right[0], right[2]];\n\tbox.faceVertexUvs[0][1] = [right[0], right[1], right[2]];\n\tbox.faceVertexUvs[0][2] = [left[3], left[0], left[2]];\n\tbox.faceVertexUvs[0][3] = [left[0], left[1], left[2]];\n\tbox.faceVertexUvs[0][4] = [top[3], top[0], top[2]];\n\tbox.faceVertexUvs[0][5] = [top[0], top[1], top[2]];\n\tbox.faceVertexUvs[0][6] = [bottom[0], bottom[3], bottom[1]];\n\tbox.faceVertexUvs[0][7] = [bottom[3], bottom[2], bottom[1]];\n\tbox.faceVertexUvs[0][8] = [front[3], front[0], front[2]];\n\tbox.faceVertexUvs[0][9] = [front[0], front[1], front[2]];\n\tbox.faceVertexUvs[0][10] = [back[3], back[0], back[2]];\n\tbox.faceVertexUvs[0][11] = [back[0], back[1], back[2]];\n}\n\nconst esp = 0.002;\n\n/**\n * Notice that innerLayer and outerLayer may NOT be the direct children of the Group.\n */\nexport class BodyPart extends Group {\n\tconstructor(\n\t\treadonly innerLayer: Object3D,\n\t\treadonly outerLayer: Object3D\n\t) {\n\t\tsuper();\n\t\tinnerLayer.name = \"inner\";\n\t\touterLayer.name = \"outer\";\n\t}\n}\n\nexport class SkinObject extends Group {\n\n\t// body parts\n\treadonly head: BodyPart;\n\treadonly body: BodyPart;\n\treadonly rightArm: BodyPart;\n\treadonly leftArm: BodyPart;\n\treadonly rightLeg: BodyPart;\n\treadonly leftLeg: BodyPart;\n\n\tprivate modelListeners: Array<() => void> = []; // called when model(slim property) is changed\n\tprivate _slim = false;\n\n\tconstructor(texture: Texture) {\n\t\tsuper();\n\n\t\tconst layer1Material = new MeshBasicMaterial({ map: texture, side: FrontSide });\n\t\tconst layer2Material = new MeshBasicMaterial({ map: texture, transparent: true, opacity: 1, side: DoubleSide, alphaTest: 0.5 });\n\n\t\t// Head\n\t\tconst headBox = new BoxGeometry(8, 8, 8, 0, 0, 0);\n\t\tsetVertices(headBox,\n\t\t\ttoSkinVertices(8, 0, 16, 8),\n\t\t\ttoSkinVertices(16, 0, 24, 8),\n\t\t\ttoSkinVertices(0, 8, 8, 16),\n\t\t\ttoSkinVertices(8, 8, 16, 16),\n\t\t\ttoSkinVertices(16, 8, 24, 16),\n\t\t\ttoSkinVertices(24, 8, 32, 16)\n\t\t);\n\t\tconst headMesh = new Mesh(headBox, layer1Material);\n\n\t\tconst head2Box = new BoxGeometry(9, 9, 9, 0, 0, 0);\n\t\tsetVertices(head2Box,\n\t\t\ttoSkinVertices(40, 0, 48, 8),\n\t\t\ttoSkinVertices(48, 0, 56, 8),\n\t\t\ttoSkinVertices(32, 8, 40, 16),\n\t\t\ttoSkinVertices(40, 8, 48, 16),\n\t\t\ttoSkinVertices(48, 8, 56, 16),\n\t\t\ttoSkinVertices(56, 8, 64, 16)\n\t\t);\n\t\tconst head2Mesh = new Mesh(head2Box, layer2Material);\n\t\thead2Mesh.renderOrder = -1;\n\n\t\tthis.head = new BodyPart(headMesh, head2Mesh);\n\t\tthis.head.name = \"head\";\n\t\tthis.head.add(headMesh, head2Mesh);\n\t\tthis.add(this.head);\n\n\t\t// Body\n\t\tconst bodyBox = new BoxGeometry(8, 12, 4, 0, 0, 0);\n\t\tsetVertices(bodyBox,\n\t\t\ttoSkinVertices(20, 16, 28, 20),\n\t\t\ttoSkinVertices(28, 16, 36, 20),\n\t\t\ttoSkinVertices(16, 20, 20, 32),\n\t\t\ttoSkinVertices(20, 20, 28, 32),\n\t\t\ttoSkinVertices(28, 20, 32, 32),\n\t\t\ttoSkinVertices(32, 20, 40, 32)\n\t\t);\n\t\tconst bodyMesh = new Mesh(bodyBox, layer1Material);\n\n\t\tconst body2Box = new BoxGeometry(9, 13.5, 4.5, 0, 0, 0);\n\t\tsetVertices(body2Box,\n\t\t\ttoSkinVertices(20, 32, 28, 36),\n\t\t\ttoSkinVertices(28, 32, 36, 36),\n\t\t\ttoSkinVertices(16, 36, 20, 48),\n\t\t\ttoSkinVertices(20, 36, 28, 48),\n\t\t\ttoSkinVertices(28, 36, 32, 48),\n\t\t\ttoSkinVertices(32, 36, 40, 48)\n\t\t);\n\t\tconst body2Mesh = new Mesh(body2Box, layer2Material);\n\n\t\tthis.body = new BodyPart(bodyMesh, body2Mesh);\n\t\tthis.body.name = \"body\";\n\t\tthis.body.add(bodyMesh, body2Mesh);\n\t\tthis.body.position.y = -10;\n\t\tthis.add(this.body);\n\n\t\t// Right Arm\n\t\tconst rightArmBox = new BoxGeometry(1, 1, 1, 0, 0, 0); // w/d/h is model-related\n\t\tconst rightArmMesh = new Mesh(rightArmBox, layer1Material);\n\t\tthis.modelListeners.push(() => {\n\t\t\trightArmMesh.scale.x = (this.slim ? 3 : 4) - esp;\n\t\t\trightArmMesh.scale.y = 12 - esp;\n\t\t\trightArmMesh.scale.z = 4 - esp;\n\t\t\tif (this.slim) {\n\t\t\t\tsetVertices(rightArmBox,\n\t\t\t\t\ttoSkinVertices(44, 16, 47, 20),\n\t\t\t\t\ttoSkinVertices(47, 16, 50, 20),\n\t\t\t\t\ttoSkinVertices(40, 20, 44, 32),\n\t\t\t\t\ttoSkinVertices(44, 20, 47, 32),\n\t\t\t\t\ttoSkinVertices(47, 20, 51, 32),\n\t\t\t\t\ttoSkinVertices(51, 20, 54, 32)\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tsetVertices(rightArmBox,\n\t\t\t\t\ttoSkinVertices(44, 16, 48, 20),\n\t\t\t\t\ttoSkinVertices(48, 16, 52, 20),\n\t\t\t\t\ttoSkinVertices(40, 20, 44, 32),\n\t\t\t\t\ttoSkinVertices(44, 20, 48, 32),\n\t\t\t\t\ttoSkinVertices(48, 20, 52, 32),\n\t\t\t\t\ttoSkinVertices(52, 20, 56, 32)\n\t\t\t\t);\n\t\t\t}\n\t\t\trightArmBox.uvsNeedUpdate = true;\n\t\t\trightArmBox.elementsNeedUpdate = true;\n\t\t});\n\n\t\tconst rightArm2Box = new BoxGeometry(1, 1, 1, 0, 0, 0); // w/d/h is model-related\n\t\tconst rightArm2Mesh = new Mesh(rightArm2Box, layer2Material);\n\t\trightArm2Mesh.renderOrder = 1;\n\t\tthis.modelListeners.push(() => {\n\t\t\trightArm2Mesh.scale.x = (this.slim ? 3.375 : 4.5) - esp;\n\t\t\trightArm2Mesh.scale.y = 13.5 - esp;\n\t\t\trightArm2Mesh.scale.z = 4.5 - esp;\n\t\t\tif (this.slim) {\n\t\t\t\tsetVertices(rightArm2Box,\n\t\t\t\t\ttoSkinVertices(44, 32, 47, 36),\n\t\t\t\t\ttoSkinVertices(47, 32, 50, 36),\n\t\t\t\t\ttoSkinVertices(40, 36, 44, 48),\n\t\t\t\t\ttoSkinVertices(44, 36, 47, 48),\n\t\t\t\t\ttoSkinVertices(47, 36, 51, 48),\n\t\t\t\t\ttoSkinVertices(51, 36, 54, 48)\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tsetVertices(rightArm2Box,\n\t\t\t\t\ttoSkinVertices(44, 32, 48, 36),\n\t\t\t\t\ttoSkinVertices(48, 32, 52, 36),\n\t\t\t\t\ttoSkinVertices(40, 36, 44, 48),\n\t\t\t\t\ttoSkinVertices(44, 36, 48, 48),\n\t\t\t\t\ttoSkinVertices(48, 36, 52, 48),\n\t\t\t\t\ttoSkinVertices(52, 36, 56, 48)\n\t\t\t\t);\n\t\t\t}\n\t\t\trightArm2Box.uvsNeedUpdate = true;\n\t\t\trightArm2Box.elementsNeedUpdate = true;\n\t\t});\n\n\t\tconst rightArmPivot = new Group();\n\t\trightArmPivot.add(rightArmMesh, rightArm2Mesh);\n\t\trightArmPivot.position.y = -6;\n\n\t\tthis.rightArm = new BodyPart(rightArmMesh, rightArm2Mesh);\n\t\tthis.rightArm.name = \"rightArm\";\n\t\tthis.rightArm.add(rightArmPivot);\n\t\tthis.rightArm.position.y = -4;\n\t\tthis.modelListeners.push(() => {\n\t\t\tthis.rightArm.position.x = this.slim ? -5.5 : -6;\n\t\t});\n\t\tthis.add(this.rightArm);\n\n\t\t// Left Arm\n\t\tconst leftArmBox = new BoxGeometry(1, 1, 1, 0, 0, 0); // w/d/h is model-related\n\t\tconst leftArmMesh = new Mesh(leftArmBox, layer1Material);\n\t\tthis.modelListeners.push(() => {\n\t\t\tleftArmMesh.scale.x = (this.slim ? 3 : 4) - esp;\n\t\t\tleftArmMesh.scale.y = 12 - esp;\n\t\t\tleftArmMesh.scale.z = 4 - esp;\n\t\t\tif (this.slim) {\n\t\t\t\tsetVertices(leftArmBox,\n\t\t\t\t\ttoSkinVertices(36, 48, 39, 52),\n\t\t\t\t\ttoSkinVertices(39, 48, 42, 52),\n\t\t\t\t\ttoSkinVertices(32, 52, 36, 64),\n\t\t\t\t\ttoSkinVertices(36, 52, 39, 64),\n\t\t\t\t\ttoSkinVertices(39, 52, 43, 64),\n\t\t\t\t\ttoSkinVertices(43, 52, 46, 64)\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tsetVertices(leftArmBox,\n\t\t\t\t\ttoSkinVertices(36, 48, 40, 52),\n\t\t\t\t\ttoSkinVertices(40, 48, 44, 52),\n\t\t\t\t\ttoSkinVertices(32, 52, 36, 64),\n\t\t\t\t\ttoSkinVertices(36, 52, 40, 64),\n\t\t\t\t\ttoSkinVertices(40, 52, 44, 64),\n\t\t\t\t\ttoSkinVertices(44, 52, 48, 64)\n\t\t\t\t);\n\t\t\t}\n\t\t\tleftArmBox.uvsNeedUpdate = true;\n\t\t\tleftArmBox.elementsNeedUpdate = true;\n\t\t});\n\n\t\tconst leftArm2Box = new BoxGeometry(1, 1, 1, 0, 0, 0); // w/d/h is model-related\n\t\tconst leftArm2Mesh = new Mesh(leftArm2Box, layer2Material);\n\t\tleftArm2Mesh.renderOrder = 1;\n\t\tthis.modelListeners.push(() => {\n\t\t\tleftArm2Mesh.scale.x = (this.slim ? 3.375 : 4.5) - esp;\n\t\t\tleftArm2Mesh.scale.y = 13.5 - esp;\n\t\t\tleftArm2Mesh.scale.z = 4.5 - esp;\n\t\t\tif (this.slim) {\n\t\t\t\tsetVertices(leftArm2Box,\n\t\t\t\t\ttoSkinVertices(52, 48, 55, 52),\n\t\t\t\t\ttoSkinVertices(55, 48, 58, 52),\n\t\t\t\t\ttoSkinVertices(48, 52, 52, 64),\n\t\t\t\t\ttoSkinVertices(52, 52, 55, 64),\n\t\t\t\t\ttoSkinVertices(55, 52, 59, 64),\n\t\t\t\t\ttoSkinVertices(59, 52, 62, 64)\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tsetVertices(leftArm2Box,\n\t\t\t\t\ttoSkinVertices(52, 48, 56, 52),\n\t\t\t\t\ttoSkinVertices(56, 48, 60, 52),\n\t\t\t\t\ttoSkinVertices(48, 52, 52, 64),\n\t\t\t\t\ttoSkinVertices(52, 52, 56, 64),\n\t\t\t\t\ttoSkinVertices(56, 52, 60, 64),\n\t\t\t\t\ttoSkinVertices(60, 52, 64, 64)\n\t\t\t\t);\n\t\t\t}\n\t\t\tleftArm2Box.uvsNeedUpdate = true;\n\t\t\tleftArm2Box.elementsNeedUpdate = true;\n\t\t});\n\n\t\tconst leftArmPivot = new Group();\n\t\tleftArmPivot.add(leftArmMesh, leftArm2Mesh);\n\t\tleftArmPivot.position.y = -6;\n\n\t\tthis.leftArm = new BodyPart(leftArmMesh, leftArm2Mesh);\n\t\tthis.leftArm.name = \"leftArm\";\n\t\tthis.leftArm.add(leftArmPivot);\n\t\tthis.leftArm.position.y = -4;\n\t\tthis.modelListeners.push(() => {\n\t\t\tthis.leftArm.position.x = this.slim ? 5.5 : 6;\n\t\t});\n\t\tthis.add(this.leftArm);\n\n\t\t// Right Leg\n\t\tconst rightLegBox = new BoxGeometry(4 - esp, 12 - esp, 4 - esp, 0, 0, 0);\n\t\tsetVertices(rightLegBox,\n\t\t\ttoSkinVertices(4, 16, 8, 20),\n\t\t\ttoSkinVertices(8, 16, 12, 20),\n\t\t\ttoSkinVertices(0, 20, 4, 32),\n\t\t\ttoSkinVertices(4, 20, 8, 32),\n\t\t\ttoSkinVertices(8, 20, 12, 32),\n\t\t\ttoSkinVertices(12, 20, 16, 32)\n\t\t);\n\t\tconst rightLegMesh = new Mesh(rightLegBox, layer1Material);\n\n\t\tconst rightLeg2Box = new BoxGeometry(4.5 - esp, 13.5 - esp, 4.5 - esp, 0, 0, 0);\n\t\tsetVertices(rightLeg2Box,\n\t\t\ttoSkinVertices(4, 32, 8, 36),\n\t\t\ttoSkinVertices(8, 32, 12, 36),\n\t\t\ttoSkinVertices(0, 36, 4, 48),\n\t\t\ttoSkinVertices(4, 36, 8, 48),\n\t\t\ttoSkinVertices(8, 36, 12, 48),\n\t\t\ttoSkinVertices(12, 36, 16, 48)\n\t\t);\n\t\tconst rightLeg2Mesh = new Mesh(rightLeg2Box, layer2Material);\n\t\trightLeg2Mesh.renderOrder = 1;\n\n\t\tconst rightLegPivot = new Group();\n\t\trightLegPivot.add(rightLegMesh, rightLeg2Mesh);\n\t\trightLegPivot.position.y = -6;\n\n\t\tthis.rightLeg = new BodyPart(rightLegMesh, rightLeg2Mesh);\n\t\tthis.rightLeg.name = \"rightLeg\";\n\t\tthis.rightLeg.add(rightLegPivot);\n\t\tthis.rightLeg.position.y = -16;\n\t\tthis.rightLeg.position.x = -2;\n\t\tthis.add(this.rightLeg);\n\n\t\t// Left Leg\n\t\tconst leftLegBox = new BoxGeometry(4 - esp, 12 - esp, 4 - esp, 0, 0, 0);\n\t\tsetVertices(leftLegBox,\n\t\t\ttoSkinVertices(20, 48, 24, 52),\n\t\t\ttoSkinVertices(24, 48, 28, 52),\n\t\t\ttoSkinVertices(16, 52, 20, 64),\n\t\t\ttoSkinVertices(20, 52, 24, 64),\n\t\t\ttoSkinVertices(24, 52, 28, 64),\n\t\t\ttoSkinVertices(28, 52, 32, 64)\n\t\t);\n\t\tconst leftLegMesh = new Mesh(leftLegBox, layer1Material);\n\n\t\tconst leftLeg2Box = new BoxGeometry(4.5 - esp, 13.5 - esp, 4.5 - esp, 0, 0, 0);\n\t\tsetVertices(leftLeg2Box,\n\t\t\ttoSkinVertices(4, 48, 8, 52),\n\t\t\ttoSkinVertices(8, 48, 12, 52),\n\t\t\ttoSkinVertices(0, 52, 4, 64),\n\t\t\ttoSkinVertices(4, 52, 8, 64),\n\t\t\ttoSkinVertices(8, 52, 12, 64),\n\t\t\ttoSkinVertices(12, 52, 16, 64)\n\t\t);\n\t\tconst leftLeg2Mesh = new Mesh(leftLeg2Box, layer2Material);\n\t\tleftLeg2Mesh.renderOrder = 1;\n\n\t\tconst leftLegPivot = new Group();\n\t\tleftLegPivot.add(leftLegMesh, leftLeg2Mesh);\n\t\tleftLegPivot.position.y = -6;\n\n\t\tthis.leftLeg = new BodyPart(leftLegMesh, leftLeg2Mesh);\n\t\tthis.leftLeg.name = \"leftLeg\";\n\t\tthis.leftLeg.add(leftLegPivot);\n\t\tthis.leftLeg.position.y = -16;\n\t\tthis.leftLeg.position.x = 2;\n\t\tthis.add(this.leftLeg);\n\n\t\tthis.slim = false;\n\t}\n\n\tget slim() {\n\t\treturn this._slim;\n\t}\n\n\tset slim(value) {\n\t\tthis._slim = value;\n\t\tthis.modelListeners.forEach(listener => listener());\n\t}\n\n\tprivate getBodyParts() {\n\t\treturn this.children.filter(it => it instanceof BodyPart) as Array<BodyPart>;\n\t}\n\n\tsetInnerLayerVisible(value: boolean) {\n\t\tthis.getBodyParts().forEach(part => part.innerLayer.visible = value);\n\t}\n\n\tsetOuterLayerVisible(value: boolean) {\n\t\tthis.getBodyParts().forEach(part => part.outerLayer.visible = value);\n\t}\n}\n\nexport class CapeObject extends Group {\n\n\treadonly cape: Mesh;\n\n\tconstructor(texture: Texture) {\n\t\tsuper();\n\n\t\tconst capeMaterial = new MeshBasicMaterial({ map: texture, transparent: true, opacity: 1, side: DoubleSide, alphaTest: 0.5 });\n\n\t\t// back = outside\n\t\t// front = inside\n\t\tconst capeBox = new BoxGeometry(10, 16, 1, 0, 0, 0);\n\t\tsetVertices(capeBox,\n\t\t\ttoCapeVertices(1, 0, 11, 1),\n\t\t\ttoCapeVertices(11, 0, 21, 1),\n\t\t\ttoCapeVertices(11, 1, 12, 17),\n\t\t\ttoCapeVertices(12, 1, 22, 17),\n\t\t\ttoCapeVertices(0, 1, 1, 17),\n\t\t\ttoCapeVertices(1, 1, 11, 17)\n\t\t);\n\t\tthis.cape = new Mesh(capeBox, capeMaterial);\n\t\tthis.cape.position.y = -8;\n\t\tthis.cape.position.z = -0.5;\n\t\tthis.add(this.cape);\n\t}\n}\n\nexport class PlayerObject extends Group {\n\n\treadonly skin: SkinObject;\n\treadonly cape: CapeObject;\n\n\tconstructor(skinTexture: Texture, capeTexture: Texture) {\n\t\tsuper();\n\n\t\tthis.skin = new SkinObject(skinTexture);\n\t\tthis.skin.name = \"skin\";\n\t\tthis.add(this.skin);\n\n\t\tthis.cape = new CapeObject(capeTexture);\n\t\tthis.cape.name = \"cape\";\n\t\tthis.cape.position.z = -2;\n\t\tthis.cape.position.y = -4;\n\t\tthis.cape.rotation.x = 25 * Math.PI / 180;\n\t\tthis.add(this.cape);\n\t}\n}\n","import { Clock } from \"three\";\nimport { PlayerObject } from \"./model.js\";\n\nexport interface IAnimation {\n\tplay(player: PlayerObject, time: number): void;\n}\n\nexport type AnimationFn = (player: PlayerObject, time: number) => void;\n\nexport type Animation = AnimationFn | IAnimation;\n\nexport function invokeAnimation(animation: Animation, player: PlayerObject, time: number) {\n\tif (animation instanceof Function) {\n\t\tanimation(player, time);\n\t} else {\n\t\t// must be IAnimation here\n\t\tanimation.play(player, time);\n\t}\n}\n\n// This interface is used to control animations\nexport interface AnimationHandle {\n\tspeed: number;\n\tpaused: boolean;\n\tprogress: number;\n\treadonly animation: Animation;\n\n\treset(): void;\n}\n\nexport interface SubAnimationHandle extends AnimationHandle {\n\tremove(): void;\n\tresetAndRemove(): void;\n}\n\nclass AnimationWrapper implements SubAnimationHandle, IAnimation {\n\tspeed: number = 1.0;\n\tpaused: boolean = false;\n\tprogress: number = 0;\n\treadonly animation: Animation;\n\n\tprivate lastTime: number = 0;\n\tprivate started: boolean = false;\n\tprivate toResetAndRemove: boolean = false;\n\n\tconstructor(animation: Animation) {\n\t\tthis.animation = animation;\n\t}\n\n\tplay(player: PlayerObject, time: number) {\n\t\tif (this.toResetAndRemove) {\n\t\t\tinvokeAnimation(this.animation, player, 0);\n\t\t\tthis.remove();\n\t\t\treturn;\n\t\t}\n\n\t\tlet delta: number;\n\t\tif (this.started) {\n\t\t\tdelta = time - this.lastTime;\n\t\t} else {\n\t\t\tdelta = 0;\n\t\t\tthis.started = true;\n\t\t}\n\t\tthis.lastTime = time;\n\t\tif (!this.paused) {\n\t\t\tthis.progress += delta * this.speed;\n\t\t}\n\t\tinvokeAnimation(this.animation, player, this.progress);\n\t}\n\n\treset() {\n\t\tthis.progress = 0;\n\t}\n\n\tremove() {\n\t\t// stub get's overriden\n\t}\n\n\tresetAndRemove() {\n\t\tthis.toResetAndRemove = true;\n\t}\n}\n\nexport class CompositeAnimation implements IAnimation {\n\n\treadonly handles: Set<AnimationHandle & IAnimation> = new Set();\n\n\tadd(animation: Animation): AnimationHandle {\n\t\tconst handle = new AnimationWrapper(animation);\n\t\thandle.remove = () => {\n\t\t\tthis.handles.delete(handle);\n\t\t};\n\t\tthis.handles.add(handle);\n\t\treturn handle;\n\t}\n\n\tplay(player: PlayerObject, time: number) {\n\t\tthis.handles.forEach(handle => handle.play(player, time));\n\t}\n}\n\nexport class RootAnimation extends CompositeAnimation implements AnimationHandle {\n\tspeed: number = 1.0;\n\tprogress: number = 0.0;\n\treadonly clock: Clock = new Clock(true);\n\n\tget animation() {\n\t\treturn this;\n\t}\n\n\tget paused() {\n\t\treturn !this.clock.running;\n\t}\n\n\tset paused(value) {\n\t\tif (value) {\n\t\t\tthis.clock.stop();\n\t\t} else {\n\t\t\tthis.clock.start();\n\t\t}\n\t}\n\n\trunAnimationLoop(player: PlayerObject): void {\n\t\tif (this.handles.size === 0) {\n\t\t\treturn;\n\t\t}\n\t\tthis.progress += this.clock.getDelta() * this.speed;\n\t\tthis.play(player, this.progress);\n\t}\n\n\treset() {\n\t\tthis.progress = 0;\n\t}\n}\n\nexport const WalkingAnimation: Animation = (player, time) => {\n\tconst skin = player.skin;\n\n\t// Multiply by animation's natural speed\n\ttime *= 8;\n\n\t// Leg swing\n\tskin.leftLeg.rotation.x = Math.sin(time) * 0.5;\n\tskin.rightLeg.rotation.x = Math.sin(time + Math.PI) * 0.5;\n\n\t// Arm swing\n\tskin.leftArm.rotation.x = Math.sin(time + Math.PI) * 0.5;\n\tskin.rightArm.rotation.x = Math.sin(time) * 0.5;\n\tconst basicArmRotationZ = Math.PI * 0.02;\n\tskin.leftArm.rotation.z = Math.cos(time) * 0.03 + basicArmRotationZ;\n\tskin.rightArm.rotation.z = Math.cos(time + Math.PI) * 0.03 - basicArmRotationZ;\n\n\t// Head shaking with different frequency & amplitude\n\tskin.head.rotation.y = Math.sin(time / 4) * 0.2;\n\tskin.head.rotation.x = Math.sin(time / 5) * 0.1;\n\n\t// Always add an angle for cape around the x axis\n\tconst basicCapeRotationX = Math.PI * 0.06;\n\tplayer.cape.rotation.x = Math.sin(time / 1.5) * 0.06 + basicCapeRotationX;\n};\n\nexport const RunningAnimation: Animation = (player, time) => {\n\tconst skin = player.skin;\n\n\ttime *= 15;\n\n\t// Leg swing with larger amplitude\n\tskin.leftLeg.rotation.x = Math.cos(time + Math.PI) * 1.3;\n\tskin.rightLeg.rotation.x = Math.cos(time) * 1.3;\n\n\t// Arm swing\n\tskin.leftArm.rotation.x = Math.cos(time) * 1.5;\n\tskin.rightArm.rotation.x = Math.cos(time + Math.PI) * 1.5;\n\tconst basicArmRotationZ = Math.PI * 0.1;\n\tskin.leftArm.rotation.z = Math.cos(time) * 0.1 + basicArmRotationZ;\n\tskin.rightArm.rotation.z = Math.cos(time + Math.PI) * 0.1 - basicArmRotationZ;\n\n\t// Jumping\n\tplayer.position.y = Math.cos(time * 2);\n\t// Dodging when running\n\tplayer.position.x = Math.cos(time) * 0.15;\n\t// Slightly tilting when running\n\tplayer.rotation.z = Math.cos(time + Math.PI) * 0.01;\n\n\t// Apply higher swing frequency, lower amplitude,\n\t// and greater basic rotation around x axis,\n\t// to cape when running.\n\tconst basicCapeRotationX = Math.PI * 0.3;\n\tplayer.cape.rotation.x = Math.sin(time * 2) * 0.1 + basicCapeRotationX;\n\n\t// What about head shaking?\n\t// You shouldn't glance right and left when running dude :P\n};\n\nexport const RotatingAnimation: Animation = (player, time) => {\n\tplayer.rotation.y = time;\n};\n","function copyImage(context, sX, sY, w, h, dX, dY, flipHorizontal) {\n    var imgData = context.getImageData(sX, sY, w, h);\n    if (flipHorizontal) {\n        for (var y = 0; y < h; y++) {\n            for (var x = 0; x < (w / 2); x++) {\n                var index = (x + y * w) * 4;\n                var index2 = ((w - x - 1) + y * w) * 4;\n                var pA1 = imgData.data[index];\n                var pA2 = imgData.data[index + 1];\n                var pA3 = imgData.data[index + 2];\n                var pA4 = imgData.data[index + 3];\n                var pB1 = imgData.data[index2];\n                var pB2 = imgData.data[index2 + 1];\n                var pB3 = imgData.data[index2 + 2];\n                var pB4 = imgData.data[index2 + 3];\n                imgData.data[index] = pB1;\n                imgData.data[index + 1] = pB2;\n                imgData.data[index + 2] = pB3;\n                imgData.data[index + 3] = pB4;\n                imgData.data[index2] = pA1;\n                imgData.data[index2 + 1] = pA2;\n                imgData.data[index2 + 2] = pA3;\n                imgData.data[index2 + 3] = pA4;\n            }\n        }\n    }\n    context.putImageData(imgData, dX, dY);\n}\nfunction hasTransparency(context, x0, y0, w, h) {\n    var imgData = context.getImageData(x0, y0, w, h);\n    for (var x = 0; x < w; x++) {\n        for (var y = 0; y < h; y++) {\n            var offset = (x + y * w) * 4;\n            if (imgData.data[offset + 3] !== 0xff) {\n                return true;\n            }\n        }\n    }\n    return false;\n}\nfunction computeSkinScale(width) {\n    return width / 64.0;\n}\nfunction fixOpaqueSkin(context, width) {\n    // Some ancient skins don't have transparent pixels (nor have helm).\n    // We have to make the helm area transparent, otherwise it will be rendered as black.\n    if (!hasTransparency(context, 0, 0, width, width / 2)) {\n        var scale_1 = computeSkinScale(width);\n        var clearArea = function (x, y, w, h) {\n            return context.clearRect(x * scale_1, y * scale_1, w * scale_1, h * scale_1);\n        };\n        clearArea(40, 0, 8, 8); // Helm Top\n        clearArea(48, 0, 8, 8); // Helm Bottom\n        clearArea(32, 8, 8, 8); // Helm Right\n        clearArea(40, 8, 8, 8); // Helm Front\n        clearArea(48, 8, 8, 8); // Helm Left\n        clearArea(56, 8, 8, 8); // Helm Back\n    }\n}\nfunction convertSkinTo1_8(context, width) {\n    var scale = computeSkinScale(width);\n    var copySkin = function (sX, sY, w, h, dX, dY, flipHorizontal) {\n        return copyImage(context, sX * scale, sY * scale, w * scale, h * scale, dX * scale, dY * scale, flipHorizontal);\n    };\n    fixOpaqueSkin(context, width);\n    copySkin(4, 16, 4, 4, 20, 48, true); // Top Leg\n    copySkin(8, 16, 4, 4, 24, 48, true); // Bottom Leg\n    copySkin(0, 20, 4, 12, 24, 52, true); // Outer Leg\n    copySkin(4, 20, 4, 12, 20, 52, true); // Front Leg\n    copySkin(8, 20, 4, 12, 16, 52, true); // Inner Leg\n    copySkin(12, 20, 4, 12, 28, 52, true); // Back Leg\n    copySkin(44, 16, 4, 4, 36, 48, true); // Top Arm\n    copySkin(48, 16, 4, 4, 40, 48, true); // Bottom Arm\n    copySkin(40, 20, 4, 12, 40, 52, true); // Outer Arm\n    copySkin(44, 20, 4, 12, 36, 52, true); // Front Arm\n    copySkin(48, 20, 4, 12, 32, 52, true); // Inner Arm\n    copySkin(52, 20, 4, 12, 44, 52, true); // Back Arm\n}\nexport function loadSkinToCanvas(canvas, image) {\n    var isOldFormat = false;\n    if (image.width !== image.height) {\n        if (image.width === 2 * image.height) {\n            isOldFormat = true;\n        }\n        else {\n            throw new Error(\"Bad skin size: \" + image.width + \"x\" + image.height);\n        }\n    }\n    var context = canvas.getContext(\"2d\");\n    if (isOldFormat) {\n        var sideLength = image.width;\n        canvas.width = sideLength;\n        canvas.height = sideLength;\n        context.clearRect(0, 0, sideLength, sideLength);\n        context.drawImage(image, 0, 0, sideLength, sideLength / 2.0);\n        convertSkinTo1_8(context, sideLength);\n    }\n    else {\n        canvas.width = image.width;\n        canvas.height = image.height;\n        context.clearRect(0, 0, image.width, image.height);\n        context.drawImage(image, 0, 0, canvas.width, canvas.height);\n    }\n}\nexport function loadCapeToCanvas(canvas, image) {\n    var isOldFormat = false;\n    if (image.width !== 2 * image.height) {\n        if (image.width * 17 === image.height * 22) {\n            // width/height = 22/17\n            isOldFormat = true;\n        }\n        else {\n            throw new Error(\"Bad cape size: \" + image.width + \"x\" + image.height);\n        }\n    }\n    var context = canvas.getContext(\"2d\");\n    if (isOldFormat) {\n        var width = image.width * 64 / 22;\n        canvas.width = width;\n        canvas.height = width / 2;\n    }\n    else {\n        canvas.width = image.width;\n        canvas.height = image.height;\n    }\n    context.clearRect(0, 0, canvas.width, canvas.height);\n    context.drawImage(image, 0, 0, image.width, image.height);\n}\nexport function isSlimSkin(canvas) {\n    // Detects whether the skin is default or slim.\n    //\n    // The right arm area of *default* skins:\n    // (44,16)->*-------*-------*\n    // (40,20)  |top    |bottom |\n    // \\|/      |4x4    |4x4    |\n    //  *-------*-------*-------*-------*\n    //  |right  |front  |left   |back   |\n    //  |4x12   |4x12   |4x12   |4x12   |\n    //  *-------*-------*-------*-------*\n    // The right arm area of *slim* skins:\n    // (44,16)->*------*------*-*\n    // (40,20)  |top   |bottom| |<----[x0=50,y0=16,w=2,h=4]\n    // \\|/      |3x4   |3x4   | |\n    //  *-------*------*------***-----*-*\n    //  |right  |front |left   |back  | |<----[x0=54,y0=20,w=2,h=12]\n    //  |4x12   |3x12  |4x12   |3x12  | |\n    //  *-------*------*-------*------*-*\n    // Compared with default right arms, slim right arms have 2 unused areas.\n    //\n    // The same is true for left arm:\n    // The left arm area of *default* skins:\n    // (36,48)->*-------*-------*\n    // (32,52)  |top    |bottom |\n    // \\|/      |4x4    |4x4    |\n    //  *-------*-------*-------*-------*\n    //  |right  |front  |left   |back   |\n    //  |4x12   |4x12   |4x12   |4x12   |\n    //  *-------*-------*-------*-------*\n    // The left arm area of *slim* skins:\n    // (36,48)->*------*------*-*\n    // (32,52)  |top   |bottom| |<----[x0=42,y0=48,w=2,h=4]\n    // \\|/      |3x4   |3x4   | |\n    //  *-------*------*------***-----*-*\n    //  |right  |front |left   |back  | |<----[x0=46,y0=52,w=2,h=12]\n    //  |4x12   |3x12  |4x12   |3x12  | |\n    //  *-------*------*-------*------*-*\n    //\n    // If there is a transparent pixel in any of the 4 unused areas, the skin must be slim,\n    // as transparent pixels are not allowed in the first layer.\n    var scale = computeSkinScale(canvas.width);\n    var context = canvas.getContext(\"2d\");\n    var checkArea = function (x, y, w, h) {\n        return hasTransparency(context, x * scale, y * scale, w * scale, h * scale);\n    };\n    return checkArea(50, 16, 2, 4) ||\n        checkArea(54, 20, 2, 12) ||\n        checkArea(42, 48, 2, 4) ||\n        checkArea(46, 52, 2, 12);\n}\n","import { EventDispatcher, MOUSE, OrthographicCamera, PerspectiveCamera, Quaternion, Spherical, Vector2, Vector3 } from \"three\";\nimport { SkinViewer } from \"./viewer.js\";\n\nconst STATE = {\n\tNONE: - 1,\n\tROTATE: 0,\n\tDOLLY: 1,\n\tPAN: 2,\n\tTOUCH_ROTATE: 3,\n\tTOUCH_DOLLY: 4,\n\tTOUCH_PAN: 5\n};\n\nconst CHANGE_EVENT = { type: \"change\" };\nconst START_EVENT = { type: \"start\" };\nconst END_EVENT = { type: \"end\" };\nconst EPS = 0.000001;\n\nexport class OrbitControls extends EventDispatcher {\n\t/**\n\t * @preserve\n\t * The code was originally from https://github.com/mrdoob/three.js/blob/d45a042cf962e9b1aa9441810ba118647b48aacb/examples/js/controls/OrbitControls.js\n\t */\n\t/**\n\t * @license\n\t * Copyright (C) 2010-2017 three.js authors\n\t *\n\t * Permission is hereby granted, free of charge, to any person obtaining a copy\n\t * of this software and associated documentation files (the \"Software\"), to deal\n\t * in the Software without restriction, including without limitation the rights\n\t * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n\t * copies of the Software, and to permit persons to whom the Software is\n\t * furnished to do so, subject to the following conditions:\n\t *\n\t * The above copyright notice and this permission notice shall be included in\n\t * all copies or substantial portions of the Software.\n\t *\n\t * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n\t * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n\t * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n\t * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n\t * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n\t * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n\t * THE SOFTWARE.\n\t *\n\t *\n\t * @author qiao / https://github.com/qiao\n\t * @author mrdoob / http://mrdoob.com\n\t * @author alteredq / http://alteredqualia.com/\n\t * @author WestLangley / http://github.com/WestLangley\n\t * @author erich666 / http://erichaines.com\n\t */\n\n\t// This set of controls performs orbiting, dollying (zooming), and panning.\n\t// Unlike TrackballControls, it maintains the \"up\" direction object.up (+Y by default).\n\t//\n\t//    Orbit - left mouse / touch: one finger move\n\t//    Zoom - middle mouse, or mousewheel / touch: two finger spread or squish\n\t//    Pan - right mouse, or arrow keys / touch: three finger swipe\n\n\tobject: PerspectiveCamera | OrthographicCamera;\n\tdomElement: HTMLElement;\n\twindow: Window;\n\n\t// API\n\tenabled: boolean;\n\ttarget: Vector3;\n\n\tenableZoom: boolean;\n\tzoomSpeed: number;\n\tminDistance: number;\n\tmaxDistance: number;\n\tenableRotate: boolean;\n\trotateSpeed: number;\n\tenablePan: boolean;\n\tkeyPanSpeed: number;\n\tautoRotate: boolean;\n\tautoRotateSpeed: number;\n\tminZoom: number;\n\tmaxZoom: number;\n\tminPolarAngle: number;\n\tmaxPolarAngle: number;\n\tminAzimuthAngle: number;\n\tmaxAzimuthAngle: number;\n\tenableKeys: boolean;\n\tkeys: { LEFT: number; UP: number; RIGHT: number; BOTTOM: number };\n\tmouseButtons: { ORBIT: MOUSE; ZOOM: MOUSE; PAN: MOUSE };\n\tenableDamping: boolean;\n\tdampingFactor: number;\n\n\tprivate spherical: Spherical;\n\tprivate sphericalDelta: Spherical;\n\tprivate scale: number;\n\tprivate target0: Vector3;\n\tprivate position0: Vector3;\n\tprivate zoom0: number;\n\tprivate state: number;\n\tprivate panOffset: Vector3;\n\tprivate zoomChanged: boolean;\n\n\tprivate rotateStart: Vector2;\n\tprivate rotateEnd: Vector2;\n\tprivate rotateDelta: Vector2;\n\n\tprivate panStart: Vector2;\n\tprivate panEnd: Vector2;\n\tprivate panDelta: Vector2;\n\n\tprivate dollyStart: Vector2;\n\tprivate dollyEnd: Vector2;\n\tprivate dollyDelta: Vector2;\n\n\tprivate updateLastPosition: Vector3;\n\tprivate updateOffset: Vector3;\n\tprivate updateQuat: Quaternion;\n\tprivate updateLastQuaternion: Quaternion;\n\tprivate updateQuatInverse: Quaternion;\n\n\tprivate panLeftV: Vector3;\n\tprivate panUpV: Vector3;\n\tprivate panInternalOffset: Vector3;\n\n\tprivate onContextMenu: (event: MouseEvent) => void;\n\tprivate onMouseUp: (event: MouseEvent) => void;\n\tprivate onMouseDown: (event: MouseEvent) => void;\n\tprivate onMouseMove: (event: MouseEvent) => void;\n\tprivate onMouseWheel: (event: MouseWheelEvent) => void;\n\tprivate onTouchStart: (event: TouchEvent) => void;\n\tprivate onTouchEnd: (event: TouchEvent) => void;\n\tprivate onTouchMove: (event: TouchEvent) => void;\n\tprivate onKeyDown: (event: KeyboardEvent) => void;\n\n\tconstructor(object: PerspectiveCamera | OrthographicCamera, domElement: HTMLElement, domWindow?: Window) {\n\t\tsuper();\n\t\tthis.object = object;\n\n\t\tthis.domElement = domElement;\n\t\tthis.window = (domWindow !== undefined) ? domWindow : window;\n\n\t\t// Set to false to disable this control\n\t\tthis.enabled = true;\n\n\t\t// \"target\" sets the location of focus, where the object orbits around\n\t\tthis.target = new Vector3();\n\n\t\t// How far you can dolly in and out ( PerspectiveCamera only )\n\t\tthis.minDistance = 0;\n\t\tthis.maxDistance = Infinity;\n\n\t\t// How far you can zoom in and out ( OrthographicCamera only )\n\t\tthis.minZoom = 0;\n\t\tthis.maxZoom = Infinity;\n\n\t\t// How far you can orbit vertically, upper and lower limits.\n\t\t// Range is 0 to Math.PI radians.\n\t\tthis.minPolarAngle = 0; // radians\n\t\tthis.maxPolarAngle = Math.PI; // radians\n\n\t\t// How far you can orbit horizontally, upper and lower limits.\n\t\t// If set, must be a sub-interval of the interval [ - Math.PI, Math.PI ].\n\t\tthis.minAzimuthAngle = - Infinity; // radians\n\t\tthis.maxAzimuthAngle = Infinity; // radians\n\n\t\t// Set to true to enable damping (inertia)\n\t\t// If damping is enabled, you must call controls.update() in your animation loop\n\t\tthis.enableDamping = false;\n\t\tthis.dampingFactor = 0.25;\n\n\t\t// This option actually enables dollying in and out; left as \"zoom\" for backwards compatibility.\n\t\t// Set to false to disable zooming\n\t\tthis.enableZoom = true;\n\t\tthis.zoomSpeed = 1.0;\n\n\t\t// Set to false to disable rotating\n\t\tthis.enableRotate = true;\n\t\tthis.rotateSpeed = 1.0;\n\n\t\t// Set to false to disable panning\n\t\tthis.enablePan = true;\n\t\tthis.keyPanSpeed = 7.0;\t// pixels moved per arrow key push\n\n\t\t// Set to true to automatically rotate around the target\n\t\t// If auto-rotate is enabled, you must call controls.update() in your animation loop\n\t\tthis.autoRotate = false;\n\t\tthis.autoRotateSpeed = 2.0; // 30 seconds per round when fps is 60\n\n\t\t// Set to false to disable use of the keys\n\t\tthis.enableKeys = true;\n\n\t\t// The four arrow keys\n\t\tthis.keys = { LEFT: 37, UP: 38, RIGHT: 39, BOTTOM: 40 };\n\n\t\t// Mouse buttons\n\t\tthis.mouseButtons = { ORBIT: MOUSE.LEFT, ZOOM: MOUSE.MIDDLE, PAN: MOUSE.RIGHT };\n\n\t\t// for reset\n\t\tthis.target0 = this.target.clone();\n\t\tthis.position0 = this.object.position.clone();\n\t\tthis.zoom0 = this.object.zoom;\n\n\t\t// for update speedup\n\t\tthis.updateOffset = new Vector3();\n\t\t// so camera.up is the orbit axis\n\t\tthis.updateQuat = new Quaternion().setFromUnitVectors(object.up, new Vector3(0, 1, 0));\n\t\tthis.updateQuatInverse = this.updateQuat.clone().inverse();\n\t\tthis.updateLastPosition = new Vector3();\n\t\tthis.updateLastQuaternion = new Quaternion();\n\n\t\tthis.state = STATE.NONE;\n\t\tthis.scale = 1;\n\n\t\t// current position in spherical coordinates\n\t\tthis.spherical = new Spherical();\n\t\tthis.sphericalDelta = new Spherical();\n\n\t\tthis.panOffset = new Vector3();\n\t\tthis.zoomChanged = false;\n\n\t\tthis.rotateStart = new Vector2();\n\t\tthis.rotateEnd = new Vector2();\n\t\tthis.rotateDelta = new Vector2();\n\n\t\tthis.panStart = new Vector2();\n\t\tthis.panEnd = new Vector2();\n\t\tthis.panDelta = new Vector2();\n\n\t\tthis.dollyStart = new Vector2();\n\t\tthis.dollyEnd = new Vector2();\n\t\tthis.dollyDelta = new Vector2();\n\n\t\tthis.panLeftV = new Vector3();\n\t\tthis.panUpV = new Vector3();\n\t\tthis.panInternalOffset = new Vector3();\n\n\t\t// event handlers - FSM: listen for events and reset state\n\n\t\tthis.onMouseDown = event => {\n\t\t\tif (this.enabled === false) return;\n\t\t\tevent.preventDefault();\n\t\t\tif (event.button === this.mouseButtons.ORBIT) {\n\t\t\t\tif (this.enableRotate === false) return;\n\t\t\t\tthis.rotateStart.set(event.clientX, event.clientY);\n\t\t\t\tthis.state = STATE.ROTATE;\n\t\t\t} else if (event.button === this.mouseButtons.ZOOM) {\n\t\t\t\tif (this.enableZoom === false) return;\n\t\t\t\tthis.dollyStart.set(event.clientX, event.clientY);\n\t\t\t\tthis.state = STATE.DOLLY;\n\t\t\t} else if (event.button === this.mouseButtons.PAN) {\n\t\t\t\tif (this.enablePan === false) return;\n\t\t\t\tthis.panStart.set(event.clientX, event.clientY);\n\t\t\t\tthis.state = STATE.PAN;\n\t\t\t}\n\n\t\t\tif (this.state !== STATE.NONE) {\n\t\t\t\tdocument.addEventListener(\"mousemove\", this.onMouseMove, false);\n\t\t\t\tdocument.addEventListener(\"mouseup\", this.onMouseUp, false);\n\t\t\t\tthis.dispatchEvent(START_EVENT);\n\t\t\t}\n\t\t};\n\n\t\tthis.onMouseMove = event => {\n\t\t\tif (this.enabled === false) return;\n\n\t\t\tevent.preventDefault();\n\n\t\t\tif (this.state === STATE.ROTATE) {\n\t\t\t\tif (this.enableRotate === false) return;\n\t\t\t\tthis.rotateEnd.set(event.clientX, event.clientY);\n\t\t\t\tthis.rotateDelta.subVectors(this.rotateEnd, this.rotateStart);\n\n\t\t\t\t// rotating across whole screen goes 360 degrees around\n\t\t\t\tthis.rotateLeft(2 * Math.PI * this.rotateDelta.x / this.domElement.clientWidth * this.rotateSpeed);\n\t\t\t\t// rotating up and down along whole screen attempts to go 360, but limited to 180\n\t\t\t\tthis.rotateUp(2 * Math.PI * this.rotateDelta.y / this.domElement.clientHeight * this.rotateSpeed);\n\t\t\t\tthis.rotateStart.copy(this.rotateEnd);\n\n\t\t\t\tthis.update();\n\t\t\t} else if (this.state === STATE.DOLLY) {\n\n\t\t\t\tif (this.enableZoom === false) return;\n\n\t\t\t\tthis.dollyEnd.set(event.clientX, event.clientY);\n\t\t\t\tthis.dollyDelta.subVectors(this.dollyEnd, this.dollyStart);\n\n\t\t\t\tif (this.dollyDelta.y > 0) {\n\t\t\t\t\tthis.dollyIn(this.getZoomScale());\n\t\t\t\t} else if (this.dollyDelta.y < 0) {\n\t\t\t\t\tthis.dollyOut(this.getZoomScale());\n\t\t\t\t}\n\n\t\t\t\tthis.dollyStart.copy(this.dollyEnd);\n\t\t\t\tthis.update();\n\t\t\t} else if (this.state === STATE.PAN) {\n\n\t\t\t\tif (this.enablePan === false) return;\n\n\t\t\t\tthis.panEnd.set(event.clientX, event.clientY);\n\t\t\t\tthis.panDelta.subVectors(this.panEnd, this.panStart);\n\t\t\t\tthis.pan(this.panDelta.x, this.panDelta.y);\n\t\t\t\tthis.panStart.copy(this.panEnd);\n\t\t\t\tthis.update();\n\t\t\t}\n\t\t};\n\n\t\tthis.onMouseUp = () => {\n\t\t\tif (this.enabled === false) return;\n\t\t\tdocument.removeEventListener(\"mousemove\", this.onMouseMove, false);\n\t\t\tdocument.removeEventListener(\"mouseup\", this.onMouseUp, false);\n\n\t\t\tthis.dispatchEvent(END_EVENT);\n\t\t\tthis.state = STATE.NONE;\n\t\t};\n\n\t\tthis.onMouseWheel = event => {\n\n\t\t\tif (this.enabled === false || this.enableZoom === false || (this.state !== STATE.NONE && this.state !== STATE.ROTATE)) return;\n\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopPropagation();\n\n\t\t\tif (event.deltaY < 0) {\n\t\t\t\tthis.dollyOut(this.getZoomScale());\n\t\t\t} else if (event.deltaY > 0) {\n\t\t\t\tthis.dollyIn(this.getZoomScale());\n\t\t\t}\n\n\t\t\tthis.update();\n\n\t\t\tthis.dispatchEvent(START_EVENT); // not sure why these are here...\n\t\t\tthis.dispatchEvent(END_EVENT);\n\t\t};\n\n\t\tthis.onKeyDown = event => {\n\n\t\t\tif (this.enabled === false || this.enableKeys === false || this.enablePan === false) return;\n\n\t\t\tswitch (event.keyCode) {\n\t\t\t\tcase this.keys.UP: {\n\t\t\t\t\tthis.pan(0, this.keyPanSpeed);\n\t\t\t\t\tthis.update();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase this.keys.BOTTOM: {\n\t\t\t\t\tthis.pan(0, - this.keyPanSpeed);\n\t\t\t\t\tthis.update();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase this.keys.LEFT: {\n\t\t\t\t\tthis.pan(this.keyPanSpeed, 0);\n\t\t\t\t\tthis.update();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase this.keys.RIGHT: {\n\t\t\t\t\tthis.pan(- this.keyPanSpeed, 0);\n\t\t\t\t\tthis.update();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tthis.onTouchStart = event => {\n\t\t\tif (this.enabled === false) return;\n\n\t\t\tswitch (event.touches.length) {\n\t\t\t\t// one-fingered touch: rotate\n\t\t\t\tcase 1: {\n\t\t\t\t\tif (this.enableRotate === false) return;\n\n\t\t\t\t\tthis.rotateStart.set(event.touches[0].pageX, event.touches[0].pageY);\n\t\t\t\t\tthis.state = STATE.TOUCH_ROTATE;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t// two-fingered touch: dolly\n\t\t\t\tcase 2: {\n\t\t\t\t\tif (this.enableZoom === false) return;\n\n\t\t\t\t\tconst dx = event.touches[0].pageX - event.touches[1].pageX;\n\t\t\t\t\tconst dy = event.touches[0].pageY - event.touches[1].pageY;\n\n\t\t\t\t\tconst distance = Math.sqrt(dx * dx + dy * dy);\n\t\t\t\t\tthis.dollyStart.set(0, distance);\n\t\t\t\t\tthis.state = STATE.TOUCH_DOLLY;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t// three-fingered touch: pan\n\t\t\t\tcase 3: {\n\t\t\t\t\tif (this.enablePan === false) return;\n\n\t\t\t\t\tthis.panStart.set(event.touches[0].pageX, event.touches[0].pageY);\n\t\t\t\t\tthis.state = STATE.TOUCH_PAN;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault: {\n\t\t\t\t\tthis.state = STATE.NONE;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.state !== STATE.NONE) {\n\t\t\t\tthis.dispatchEvent(START_EVENT);\n\t\t\t}\n\t\t};\n\n\t\tthis.onTouchMove = event => {\n\t\t\tif (this.enabled === false) return;\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopPropagation();\n\n\t\t\tswitch (event.touches.length) {\n\t\t\t\t// one-fingered touch: rotate\n\t\t\t\tcase 1: {\n\t\t\t\t\tif (this.enableRotate === false) return;\n\t\t\t\t\tif (this.state !== STATE.TOUCH_ROTATE) return; // is this needed?...\n\n\t\t\t\t\tthis.rotateEnd.set(event.touches[0].pageX, event.touches[0].pageY);\n\t\t\t\t\tthis.rotateDelta.subVectors(this.rotateEnd, this.rotateStart);\n\n\t\t\t\t\t// rotating across whole screen goes 360 degrees around\n\t\t\t\t\tthis.rotateLeft(2 * Math.PI * this.rotateDelta.x / this.domElement.clientWidth * this.rotateSpeed);\n\n\t\t\t\t\t// rotating up and down along whole screen attempts to go 360, but limited to 180\n\t\t\t\t\tthis.rotateUp(2 * Math.PI * this.rotateDelta.y / this.domElement.clientHeight * this.rotateSpeed);\n\n\t\t\t\t\tthis.rotateStart.copy(this.rotateEnd);\n\n\t\t\t\t\tthis.update();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t// two-fingered touch: dolly\n\t\t\t\tcase 2: {\n\t\t\t\t\tif (this.enableZoom === false) return;\n\t\t\t\t\tif (this.state !== STATE.TOUCH_DOLLY) return; // is this needed?...\n\n\t\t\t\t\t// console.log( \"handleTouchMoveDolly\" );\n\t\t\t\t\tconst dx = event.touches[0].pageX - event.touches[1].pageX;\n\t\t\t\t\tconst dy = event.touches[0].pageY - event.touches[1].pageY;\n\n\t\t\t\t\tconst distance = Math.sqrt(dx * dx + dy * dy);\n\n\t\t\t\t\tthis.dollyEnd.set(0, distance);\n\n\t\t\t\t\tthis.dollyDelta.subVectors(this.dollyEnd, this.dollyStart);\n\n\t\t\t\t\tif (this.dollyDelta.y > 0) {\n\t\t\t\t\t\tthis.dollyOut(this.getZoomScale());\n\t\t\t\t\t} else if (this.dollyDelta.y < 0) {\n\t\t\t\t\t\tthis.dollyIn(this.getZoomScale());\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.dollyStart.copy(this.dollyEnd);\n\t\t\t\t\tthis.update();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t// three-fingered touch: pan\n\t\t\t\tcase 3: {\n\t\t\t\t\tif (this.enablePan === false) return;\n\t\t\t\t\tif (this.state !== STATE.TOUCH_PAN) return; // is this needed?...\n\t\t\t\t\tthis.panEnd.set(event.touches[0].pageX, event.touches[0].pageY);\n\t\t\t\t\tthis.panDelta.subVectors(this.panEnd, this.panStart);\n\t\t\t\t\tthis.pan(this.panDelta.x, this.panDelta.y);\n\t\t\t\t\tthis.panStart.copy(this.panEnd);\n\t\t\t\t\tthis.update();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault: {\n\t\t\t\t\tthis.state = STATE.NONE;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tthis.onTouchEnd = () => {\n\t\t\tif (this.enabled === false) return;\n\t\t\tthis.dispatchEvent(END_EVENT);\n\t\t\tthis.state = STATE.NONE;\n\t\t};\n\n\t\tthis.onContextMenu = event => {\n\t\t\tevent.preventDefault();\n\t\t};\n\n\t\tthis.domElement.addEventListener(\"contextmenu\", this.onContextMenu, false);\n\n\t\tthis.domElement.addEventListener(\"mousedown\", this.onMouseDown, false);\n\t\tthis.domElement.addEventListener(\"wheel\", this.onMouseWheel, false);\n\n\t\tthis.domElement.addEventListener(\"touchstart\", this.onTouchStart, false);\n\t\tthis.domElement.addEventListener(\"touchend\", this.onTouchEnd, false);\n\t\tthis.domElement.addEventListener(\"touchmove\", this.onTouchMove, false);\n\n\t\tthis.window.addEventListener(\"keydown\", this.onKeyDown, false);\n\n\t\t// force an update at start\n\t\tthis.update();\n\t}\n\n\tupdate() {\n\t\tconst position = this.object.position;\n\t\tthis.updateOffset.copy(position).sub(this.target);\n\n\t\t// rotate offset to \"y-axis-is-up\" space\n\t\tthis.updateOffset.applyQuaternion(this.updateQuat);\n\n\t\t// angle from z-axis around y-axis\n\t\tthis.spherical.setFromVector3(this.updateOffset);\n\n\t\tif (this.autoRotate && this.state === STATE.NONE) {\n\t\t\tthis.rotateLeft(this.getAutoRotationAngle());\n\t\t}\n\n\t\tthis.spherical.theta += this.sphericalDelta.theta;\n\t\tthis.spherical.phi += this.sphericalDelta.phi;\n\n\t\t// restrict theta to be between desired limits\n\t\tthis.spherical.theta = Math.max(this.minAzimuthAngle, Math.min(this.maxAzimuthAngle, this.spherical.theta));\n\n\t\t// restrict phi to be between desired limits\n\t\tthis.spherical.phi = Math.max(this.minPolarAngle, Math.min(this.maxPolarAngle, this.spherical.phi));\n\n\t\tthis.spherical.makeSafe();\n\n\t\tthis.spherical.radius *= this.scale;\n\n\t\t// restrict radius to be between desired limits\n\t\tthis.spherical.radius = Math.max(this.minDistance, Math.min(this.maxDistance, this.spherical.radius));\n\n\t\t// move target to panned location\n\t\tthis.target.add(this.panOffset);\n\n\t\tthis.updateOffset.setFromSpherical(this.spherical);\n\n\t\t// rotate offset back to \"camera-up-vector-is-up\" space\n\t\tthis.updateOffset.applyQuaternion(this.updateQuatInverse);\n\n\t\tposition.copy(this.target).add(this.updateOffset);\n\n\t\tthis.object.lookAt(this.target);\n\n\t\tif (this.enableDamping === true) {\n\n\t\t\tthis.sphericalDelta.theta *= (1 - this.dampingFactor);\n\t\t\tthis.sphericalDelta.phi *= (1 - this.dampingFactor);\n\n\t\t} else {\n\n\t\t\tthis.sphericalDelta.set(0, 0, 0);\n\n\t\t}\n\n\t\tthis.scale = 1;\n\t\tthis.panOffset.set(0, 0, 0);\n\n\t\t// update condition is:\n\t\t// min(camera displacement, camera rotation in radians)^2 > EPS\n\t\t// using small-angle approximation cos(x/2) = 1 - x^2 / 8\n\n\t\tif (this.zoomChanged ||\n\t\t\tthis.updateLastPosition.distanceToSquared(this.object.position) > EPS ||\n\t\t\t8 * (1 - this.updateLastQuaternion.dot(this.object.quaternion)) > EPS) {\n\n\t\t\tthis.dispatchEvent(CHANGE_EVENT);\n\t\t\tthis.updateLastPosition.copy(this.object.position);\n\t\t\tthis.updateLastQuaternion.copy(this.object.quaternion);\n\t\t\tthis.zoomChanged = false;\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tpanLeft(distance: number, objectMatrix) {\n\t\tthis.panLeftV.setFromMatrixColumn(objectMatrix, 0); // get X column of objectMatrix\n\t\tthis.panLeftV.multiplyScalar(- distance);\n\t\tthis.panOffset.add(this.panLeftV);\n\t}\n\n\tpanUp(distance: number, objectMatrix) {\n\t\tthis.panUpV.setFromMatrixColumn(objectMatrix, 1); // get Y column of objectMatrix\n\t\tthis.panUpV.multiplyScalar(distance);\n\t\tthis.panOffset.add(this.panUpV);\n\t}\n\n\t// deltaX and deltaY are in pixels; right and down are positive\n\tpan(deltaX: number, deltaY: number) {\n\t\tif (this.object instanceof PerspectiveCamera) {\n\t\t\t// perspective\n\t\t\tconst position = this.object.position;\n\t\t\tthis.panInternalOffset.copy(position).sub(this.target);\n\t\t\tlet targetDistance = this.panInternalOffset.length();\n\n\t\t\t// half of the fov is center to top of screen\n\t\t\ttargetDistance *= Math.tan((this.object.fov / 2) * Math.PI / 180.0);\n\n\t\t\t// we actually don\"t use screenWidth, since perspective camera is fixed to screen height\n\t\t\tthis.panLeft(2 * deltaX * targetDistance / this.domElement.clientHeight, this.object.matrix);\n\t\t\tthis.panUp(2 * deltaY * targetDistance / this.domElement.clientHeight, this.object.matrix);\n\t\t} else if (this.object instanceof OrthographicCamera) {\n\t\t\t// orthographic\n\t\t\tthis.panLeft(deltaX * (this.object.right - this.object.left) / this.object.zoom / this.domElement.clientWidth, this.object.matrix);\n\t\t\tthis.panUp(deltaY * (this.object.top - this.object.bottom) / this.object.zoom / this.domElement.clientHeight, this.object.matrix);\n\t\t} else {\n\t\t\t// camera neither orthographic nor perspective\n\t\t\tconsole.warn(\"WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.\");\n\t\t\tthis.enablePan = false;\n\t\t}\n\t}\n\n\tdollyIn(dollyScale) {\n\t\tif (this.object instanceof PerspectiveCamera) {\n\t\t\tthis.scale /= dollyScale;\n\t\t} else if (this.object instanceof OrthographicCamera) {\n\t\t\tthis.object.zoom = Math.max(this.minZoom, Math.min(this.maxZoom, this.object.zoom * dollyScale));\n\t\t\tthis.object.updateProjectionMatrix();\n\t\t\tthis.zoomChanged = true;\n\t\t} else {\n\t\t\tconsole.warn(\"WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.\");\n\t\t\tthis.enableZoom = false;\n\t\t}\n\t}\n\n\tdollyOut(dollyScale) {\n\t\tif (this.object instanceof PerspectiveCamera) {\n\t\t\tthis.scale *= dollyScale;\n\t\t} else if (this.object instanceof OrthographicCamera) {\n\t\t\tthis.object.zoom = Math.max(this.minZoom, Math.min(this.maxZoom, this.object.zoom / dollyScale));\n\t\t\tthis.object.updateProjectionMatrix();\n\t\t\tthis.zoomChanged = true;\n\t\t} else {\n\t\t\tconsole.warn(\"WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.\");\n\t\t\tthis.enableZoom = false;\n\t\t}\n\t}\n\n\tgetAutoRotationAngle() {\n\t\treturn 2 * Math.PI / 60 / 60 * this.autoRotateSpeed;\n\t}\n\n\tgetZoomScale() {\n\t\treturn Math.pow(0.95, this.zoomSpeed);\n\t}\n\n\trotateLeft(angle: number) {\n\t\tthis.sphericalDelta.theta -= angle;\n\t}\n\n\trotateUp(angle: number) {\n\t\tthis.sphericalDelta.phi -= angle;\n\t}\n\n\tgetPolarAngle(): number {\n\t\treturn this.spherical.phi;\n\t}\n\n\tgetAzimuthalAngle(): number {\n\t\treturn this.spherical.theta;\n\t}\n\n\tdispose(): void {\n\t\tthis.domElement.removeEventListener(\"contextmenu\", this.onContextMenu, false);\n\t\tthis.domElement.removeEventListener(\"mousedown\", this.onMouseDown, false);\n\t\tthis.domElement.removeEventListener(\"wheel\", this.onMouseWheel, false);\n\n\t\tthis.domElement.removeEventListener(\"touchstart\", this.onTouchStart, false);\n\t\tthis.domElement.removeEventListener(\"touchend\", this.onTouchEnd, false);\n\t\tthis.domElement.removeEventListener(\"touchmove\", this.onTouchMove, false);\n\n\t\tdocument.removeEventListener(\"mousemove\", this.onMouseMove, false);\n\t\tdocument.removeEventListener(\"mouseup\", this.onMouseUp, false);\n\n\t\tthis.window.removeEventListener(\"keydown\", this.onKeyDown, false);\n\t\t// this.dispatchEvent( { type: \"dispose\" } ); // should this be added here?\n\t}\n\n\treset(): void {\n\t\tthis.target.copy(this.target0);\n\t\tthis.object.position.copy(this.position0);\n\t\tthis.object.zoom = this.zoom0;\n\n\t\tthis.object.updateProjectionMatrix();\n\t\tthis.dispatchEvent(CHANGE_EVENT);\n\n\t\tthis.update();\n\n\t\tthis.state = STATE.NONE;\n\t}\n}\n\nexport function createOrbitControls(skinViewer: SkinViewer) {\n\tconst control = new OrbitControls(skinViewer.camera, skinViewer.renderer.domElement);\n\n\t// default configuration\n\tcontrol.enablePan = false;\n\tcontrol.target = new Vector3(0, -12, 0);\n\tcontrol.minDistance = 10;\n\tcontrol.maxDistance = 256;\n\tcontrol.update();\n\n\treturn control;\n}\n","import { NearestFilter, PerspectiveCamera, Scene, Texture, Vector2, WebGLRenderer } from \"three\";\nimport { RootAnimation } from \"./animation.js\";\nimport { PlayerObject } from \"./model.js\";\nimport { isSlimSkin, loadCapeToCanvas, loadSkinToCanvas } from \"skinview-utils\";\n\nexport interface SkinViewerOptions {\n\tdomElement: Node;\n\tanimation?: Animation;\n\tskinUrl?: string;\n\tcapeUrl?: string;\n\twidth?: number;\n\theight?: number;\n\tdetectModel?: boolean;\n}\n\nexport class SkinViewer {\n\n\tpublic readonly domElement: Node;\n\tpublic readonly animations: RootAnimation = new RootAnimation();\n\tpublic detectModel: boolean = true;\n\tpublic disposed: boolean = false;\n\n\tpublic readonly skinImg: HTMLImageElement;\n\tpublic readonly skinCanvas: HTMLCanvasElement;\n\tpublic readonly skinTexture: Texture;\n\n\tpublic readonly capeImg: HTMLImageElement;\n\tpublic readonly capeCanvas: HTMLCanvasElement;\n\tpublic readonly capeTexture: Texture;\n\n\tpublic readonly scene: Scene;\n\tpublic readonly camera: PerspectiveCamera;\n\tpublic readonly renderer: WebGLRenderer;\n\n\tpublic readonly playerObject: PlayerObject;\n\n\tprivate _renderPaused: boolean = false;\n\n\tconstructor(options: SkinViewerOptions) {\n\t\tthis.domElement = options.domElement;\n\t\tif (options.detectModel === false) {\n\t\t\tthis.detectModel = false;\n\t\t}\n\n\t\t// texture\n\t\tthis.skinImg = new Image();\n\t\tthis.skinCanvas = document.createElement(\"canvas\");\n\t\tthis.skinTexture = new Texture(this.skinCanvas);\n\t\tthis.skinTexture.magFilter = NearestFilter;\n\t\tthis.skinTexture.minFilter = NearestFilter;\n\n\t\tthis.capeImg = new Image();\n\t\tthis.capeCanvas = document.createElement(\"canvas\");\n\t\tthis.capeTexture = new Texture(this.capeCanvas);\n\t\tthis.capeTexture.magFilter = NearestFilter;\n\t\tthis.capeTexture.minFilter = NearestFilter;\n\n\t\t// scene\n\t\tthis.scene = new Scene();\n\n\t\t// Use smaller fov to avoid distortion\n\t\tthis.camera = new PerspectiveCamera(40);\n\t\tthis.camera.position.y = -12;\n\t\tthis.camera.position.z = 60;\n\n\t\tthis.renderer = new WebGLRenderer({ alpha: true, antialias: false });\n\t\tthis.renderer.setSize(300, 300); // default size\n\t\tthis.domElement.appendChild(this.renderer.domElement);\n\n\t\tthis.playerObject = new PlayerObject(this.skinTexture, this.capeTexture);\n\t\tthis.playerObject.name = \"player\";\n\t\tthis.playerObject.skin.visible = false;\n\t\tthis.playerObject.cape.visible = false;\n\t\tthis.scene.add(this.playerObject);\n\n\t\t// texture loading\n\t\tthis.skinImg.crossOrigin = \"anonymous\";\n\t\tthis.skinImg.onerror = () => console.error(\"Failed loading \" + this.skinImg.src);\n\t\tthis.skinImg.onload = () => {\n\t\t\tloadSkinToCanvas(this.skinCanvas, this.skinImg);\n\n\t\t\tif (this.detectModel) {\n\t\t\t\tthis.playerObject.skin.slim = isSlimSkin(this.skinCanvas);\n\t\t\t}\n\n\t\t\tthis.skinTexture.needsUpdate = true;\n\t\t\tthis.playerObject.skin.visible = true;\n\t\t};\n\n\t\tthis.capeImg.crossOrigin = \"anonymous\";\n\t\tthis.capeImg.onerror = () => console.error(\"Failed loading \" + this.capeImg.src);\n\t\tthis.capeImg.onload = () => {\n\t\t\tloadCapeToCanvas(this.capeCanvas, this.capeImg);\n\n\t\t\tthis.capeTexture.needsUpdate = true;\n\t\t\tthis.playerObject.cape.visible = true;\n\t\t};\n\n\t\tif (options.skinUrl) this.skinUrl = options.skinUrl;\n\t\tif (options.capeUrl) this.capeUrl = options.capeUrl;\n\t\tif (options.width) this.width = options.width;\n\t\tif (options.height) this.height = options.height;\n\n\t\twindow.requestAnimationFrame(() => this.draw());\n\t}\n\n\tprivate draw() {\n\t\tif (this.disposed || this._renderPaused) {\n\t\t\treturn;\n\t\t}\n\t\tthis.animations.runAnimationLoop(this.playerObject);\n\t\tthis.renderer.render(this.scene, this.camera);\n\t\twindow.requestAnimationFrame(() => this.draw());\n\t}\n\n\tsetSize(width: number, height: number) {\n\t\tthis.camera.aspect = width / height;\n\t\tthis.camera.updateProjectionMatrix();\n\t\tthis.renderer.setSize(width, height);\n\t}\n\n\tdispose() {\n\t\tthis.disposed = true;\n\t\tthis.domElement.removeChild(this.renderer.domElement);\n\t\tthis.renderer.dispose();\n\t\tthis.skinTexture.dispose();\n\t\tthis.capeTexture.dispose();\n\t}\n\n\tget renderPaused() {\n\t\treturn this._renderPaused;\n\t}\n\n\tset renderPaused(value: boolean) {\n\t\tconst toResume = !this.disposed && !value && this._renderPaused;\n\t\tthis._renderPaused = value;\n\t\tif (toResume) {\n\t\t\twindow.requestAnimationFrame(() => this.draw());\n\t\t}\n\t}\n\n\tget skinUrl() {\n\t\treturn this.skinImg.src;\n\t}\n\n\tset skinUrl(url) {\n\t\tthis.skinImg.src = url;\n\t}\n\n\tget capeUrl() {\n\t\treturn this.capeImg.src;\n\t}\n\n\tset capeUrl(url) {\n\t\tthis.capeImg.src = url;\n\t}\n\n\tget width() {\n\t\tconst target = new Vector2();\n\t\treturn this.renderer.getSize(target).width;\n\t}\n\n\tset width(newWidth) {\n\t\tthis.setSize(newWidth, this.height);\n\t}\n\n\tget height() {\n\t\tconst target = new Vector2();\n\t\treturn this.renderer.getSize(target).height;\n\t}\n\n\tset height(newHeight) {\n\t\tthis.setSize(this.width, newHeight);\n\t}\n}\n"],"names":["toFaceVertices","x1","y1","x2","y2","w","h","Vector2","toSkinVertices","toCapeVertices","setVertices","box","top","bottom","left","front","right","back","faceVertexUvs","esp","BodyPart","Group","[object Object]","innerLayer","outerLayer","super","this","name","SkinObject","texture","layer1Material","MeshBasicMaterial","map","side","FrontSide","layer2Material","transparent","opacity","DoubleSide","alphaTest","headBox","BoxGeometry","headMesh","Mesh","head2Box","head2Mesh","renderOrder","head","add","bodyBox","bodyMesh","body2Box","body2Mesh","body","position","y","rightArmBox","rightArmMesh","modelListeners","push","scale","x","slim","z","uvsNeedUpdate","elementsNeedUpdate","rightArm2Box","rightArm2Mesh","rightArmPivot","rightArm","leftArmBox","leftArmMesh","leftArm2Box","leftArm2Mesh","leftArmPivot","leftArm","rightLegBox","rightLegMesh","rightLeg2Box","rightLeg2Mesh","rightLegPivot","rightLeg","leftLegBox","leftLegMesh","leftLeg2Box","leftLeg2Mesh","leftLegPivot","leftLeg","_slim","value","forEach","listener","children","filter","it","getBodyParts","part","visible","CapeObject","capeMaterial","capeBox","cape","PlayerObject","skinTexture","capeTexture","skin","rotation","Math","PI","invokeAnimation","animation","player","time","Function","play","AnimationWrapper","toResetAndRemove","remove","delta","started","lastTime","paused","progress","speed","CompositeAnimation","Set","handle","handles","delete","RootAnimation","Clock","clock","running","stop","start","size","getDelta","hasTransparency","context","x0","y0","imgData","getImageData","offset","data","computeSkinScale","width","convertSkinTo1_8","copySkin","sX","sY","dX","dY","flipHorizontal","index","index2","pA1","pA2","pA3","pA4","pB1","pB2","pB3","pB4","putImageData","copyImage","scale_1","clearArea","clearRect","fixOpaqueSkin","STATE","CHANGE_EVENT","type","START_EVENT","END_EVENT","OrbitControls","EventDispatcher","object","domElement","domWindow","window","undefined","enabled","target","Vector3","minDistance","maxDistance","Infinity","minZoom","maxZoom","minPolarAngle","maxPolarAngle","minAzimuthAngle","maxAzimuthAngle","enableDamping","dampingFactor","enableZoom","zoomSpeed","enableRotate","rotateSpeed","enablePan","keyPanSpeed","autoRotate","autoRotateSpeed","enableKeys","keys","LEFT","UP","RIGHT","BOTTOM","mouseButtons","ORBIT","MOUSE","ZOOM","MIDDLE","PAN","target0","clone","position0","zoom0","zoom","updateOffset","updateQuat","Quaternion","setFromUnitVectors","up","updateQuatInverse","inverse","updateLastPosition","updateLastQuaternion","state","spherical","Spherical","sphericalDelta","panOffset","zoomChanged","rotateStart","rotateEnd","rotateDelta","panStart","panEnd","panDelta","dollyStart","dollyEnd","dollyDelta","panLeftV","panUpV","panInternalOffset","onMouseDown","event","preventDefault","button","set","clientX","clientY","document","addEventListener","onMouseMove","onMouseUp","dispatchEvent","subVectors","rotateLeft","clientWidth","rotateUp","clientHeight","copy","update","dollyIn","getZoomScale","dollyOut","pan","removeEventListener","onMouseWheel","stopPropagation","deltaY","onKeyDown","keyCode","onTouchStart","touches","length","pageX","pageY","dx","dy","distance","sqrt","onTouchMove","onTouchEnd","onContextMenu","sub","applyQuaternion","setFromVector3","getAutoRotationAngle","theta","phi","max","min","makeSafe","radius","setFromSpherical","lookAt","distanceToSquared","dot","quaternion","objectMatrix","setFromMatrixColumn","multiplyScalar","deltaX","PerspectiveCamera","targetDistance","tan","fov","panLeft","matrix","panUp","OrthographicCamera","console","warn","dollyScale","updateProjectionMatrix","pow","angle","exports","cos","basicArmRotationZ","basicCapeRotationX","sin","options","detectModel","skinImg","Image","skinCanvas","createElement","Texture","magFilter","NearestFilter","minFilter","capeImg","capeCanvas","scene","Scene","camera","renderer","WebGLRenderer","alpha","antialias","setSize","appendChild","playerObject","crossOrigin","onerror","error","src","onload","canvas","checkArea","image","isOldFormat","height","Error","getContext","sideLength","drawImage","loadSkinToCanvas","needsUpdate","loadCapeToCanvas","skinUrl","capeUrl","requestAnimationFrame","draw","disposed","_renderPaused","animations","runAnimationLoop","render","aspect","removeChild","dispose","renderPaused","toResume","url","getSize","newWidth","newHeight","skinViewer","control"],"mappings":"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"}